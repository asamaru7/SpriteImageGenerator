define("SpriteGenerator",["RectanglePacking"],function(t){function e(t){return t.replace(/^data:image\/(png|jpg);base64,/,"")}function i(t,e){var i=e?1e3:1024;if(Math.abs(t)<i)return t+" B";var n=e?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],a=-1;do{t/=i,++a}while(Math.abs(t)>=i&&a<n.length-1);return t.toFixed(1)+" "+n[a]}function n(t){return t.substr(0,t.lastIndexOf(".")).replace(/[\._]/g,"-")}var a=function(t){this.setting={onFileAdded:function(t){},onValidation:function(t){},filesElement:null,dropElement:null},$.extend(!0,this.setting,t),this.option=null,this.items=[],this.resultDataURL={normal:null,retina:null},this.resultCSS={common:null,each:null,validation:null},this._initialize()};return a.prototype.addItemByFile=function(t){if(t.type.match("image.*")){var e=new FileReader;e.onload=function(t,e){return function(i){t._addImageItem(i.target.result,e.name,e.size)}}(this,t),e.readAsDataURL(t),e=null}},a.prototype.getItems=function(){return null!=this.setting.dropElement?this.setting.dropElement.children().map(function(){return $(this).data("sprite-item")}):this.items},a.prototype.generate=function(t){var e=this.getItems();if(null==e||0===e.length)return alert("Please select at least 1 image files."),null;this._initializeOption(),$.extend(!0,this.option,t),this.option.width=parseInt(this.option.width),this.option.height=parseInt(this.option.height),(isNaN(this.option.width)||isNaN(this.option.height))&&(this.option.fixedSize=!1);var i=document.createElement("canvas"),n=this._calcImageLayout(e,!1);if(i.width=n.width,i.height=n.height,this._drawCanvas(e,i),this.resultDataURL={normal:null,retina:null},this.option.retina){var a=document.createElement("canvas");n=this._calcImageLayout(e,this.option.retina),a.width=n.width,a.height=n.height,this._drawCanvas(e,a),this.resultDataURL.normal=a.toDataURL(),this.resultDataURL.retina=i.toDataURL(),this._generateCSS(e,a,i,this.option.retina),a=null}else this.resultDataURL.normal=i.toDataURL(),this._generateCSS(e,i);return i=null,this._validateCSS(e,this.option.retina),e=null,{dataURL:this.resultDataURL,css:this.resultCSS}},a.prototype.export=function(t,e){for(var i={option:t,files:[]},n=this.getItems(),a=0,o=n.length;a<o;a++)i.files.push({name:n[a].name,data:n[a].data,width:n[a].width,height:n[a].height,fileSize:n[a].fileSize});n=null;var r=JSON.stringify(i,null,2);return e&&(r=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),r=r.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(t){var e="number";return/^"/.test(t)?e=/:$/.test(t)?"key":"string":/true|false/.test(t)?e="boolean":/null/.test(t)&&(e="null"),'<span class="'+e+'">'+t+"</span>"})),{data:i,setting:r,normal:this.resultDataURL.normal,retina:this.resultDataURL.retina}},a.prototype.exportToZip=function(t){require(["JSZip"],function(i){return function(n){var a=new n;a.file(i.getJsonFileName(),i.export(t,!1).setting),null!=i.resultDataURL.normal&&a.file(i.getFileName(!1),e(i.resultDataURL.normal),{base64:!0}),null!=i.resultDataURL.retina&&a.file(i.getFileName(!0),e(i.resultDataURL.retina),{base64:!0}),require(["libs/FileSaver"],function(t,e){return function(){window.saveAs(t,e)}}(a.generate({type:"blob"}),i.option.filename+".zip"))}}(this))},a.prototype.getFileName=function(t){return this.option.filename+(t?"@2x":"")+".png"},a.prototype.getJsonFileName=function(){return this.option.filename+".sprite.json"},a.prototype.replaceFiles=function(t){if(this.items=[],null!=this.setting.dropElement&&this.setting.dropElement.empty(),$.isArray(t))for(var e=null,i=0,n=t.length;i<n;i++)e=t[i],this._addImageItem(e.data,e.name,e.fileSize)},a.prototype._initialize=function(){if(null!=this.setting.filesElement&&this.setting.filesElement.on("change",function(t){return function(e){for(var i=e.target.files,n=0,a=i.length;n<a;n++)t.addItemByFile(i[n])}}(this)),null!=this.setting.dropElement&&window.File&&window.FileList&&window.FileReader){var t=this.setting.dropElement;t.on("dragover dragleave",function(t){t.stopPropagation(),t.preventDefault(),this.className="dragover"==t.type?"hover":""}),t.on("drop",function(t){return function(e){e.stopPropagation(),e.preventDefault(),$(this).trigger("dragleave");for(var i,n=e.originalEvent,a=n.target.files||n.dataTransfer.files,o=0;i=a[o];o++)t.addItemByFile(i)}}(this)),t=null,require(["Sortable"],function(t){return function(e){e.create(t.setting.dropElement.get(0))}}(this))}},a.prototype._initializeOption=function(){this.option={retina:!1,useCr:!1,useDataUrl:!1,fixedSize:!1,width:-1,height:-1,padding:{top:0,right:0,bottom:0,left:0},layout:"ver",className:"sprite",prefix:"",filename:"sprite",urlPrefix:""}},a.prototype._addImageItem=function(t,e,n){var a=this,o=new Image;o.onload=function(){var r={name:e,image:o,data:t,width:o.width,height:o.height,fileSize:n,drawWidth:0,drawHeight:0,drawImageWidth:0,drawImageHeight:0,xOffset:0,yOffset:0,x:0,y:0};if(a.items.push(r),null!=a.setting.dropElement){var s="<span>"+r.name+"</span> <i>("+r.width+"x"+r.height;isNaN(r.fileSize)||(s+=", "+i(r.fileSize,!0)),s+=")</i>";var l=$("<li/>").append("<i>X</i>").append(r.image).append("<span>"+s+"</span>").data("sprite-item",r);l.find("span > span").on("save",function(t){return function(e,i){var n=t.data("sprite-item");n.name=i.newValue,t.data("sprite-item",n)}}(l)).editable(),l.find("> i").on("click",function(t){return function(e,i){t.remove()}}(l)),l.appendTo(a.setting.dropElement),l=null,s=null}a.setting.onFileAdded(r),r=null},o.src=t},a.prototype._calcImageLayout=function(e,i){for(var n=i?2:1,a=i?1:2,o=this.option.fixedSize,r=this.option.retina?2:1,s=Math.floor(this.option.width*r/n),l=Math.floor(this.option.height*r/n),h=0,p=0,d=0,u=0,g=0,m=e.length;g<m;g++)if(e[g].drawImageWidth=Math.floor(e[g].width/n),e[g].drawImageHeight=Math.floor(e[g].height/n),o?(e[g].drawWidth=s,e[g].drawHeight=l):(e[g].drawWidth=e[g].drawImageWidth,e[g].drawHeight=e[g].drawImageHeight),e[g].xOffset=this.option.padding.left*a+Math.ceil((e[g].drawWidth-e[g].drawImageWidth)/2),e[g].yOffset=this.option.padding.top*a+Math.ceil((e[g].drawHeight-e[g].drawImageHeight)/2),e[g].drawWidth+=(this.option.padding.left+this.option.padding.right)*a,e[g].drawHeight+=(this.option.padding.top+this.option.padding.bottom)*a,"compat"!=this.option.layout){switch(e[g].x=h,e[g].y=p,this.option.layout){case"ver":p+=e[g].drawHeight;break;case"hor":h+=e[g].drawWidth}d=Math.max(d,e[g].x+e[g].drawWidth),u=Math.max(u,e[g].y+e[g].drawHeight)}if("compat"==this.option.layout){var f=new t;f.pack(e),d=f.canvasWidth,u=f.canvasHeight}return{width:d,height:u}},a.prototype._drawCanvas=function(t,e){for(var i=e.getContext("2d"),n=void 0,a=void 0,o=0,r=t.length;o<r;o++)n=t[o].x+t[o].xOffset,a=t[o].y+t[o].yOffset,i.drawImage(t[o].image,n,a,t[o].drawImageWidth,t[o].drawImageHeight);i=null},a.prototype._getNormalCss=function(t,e,i,n,a){var o="."+this.option.className+" {"+n;return o+=a+"background-image: url('__NORMAL_IMAGE__');"+n,this.option.fixedSize&&(o+=a+"width: "+e+"px;"+n,o+=a+"height: "+i+"px;"+n),o+="}\n\n"},a.prototype._getRetinaCss=function(t,e,i,n,a,o,r){var s="."+this.option.className+" {"+o;return s+=r+r+"background-image: url('__RETINA_IMAGE__');"+o,s+=r+r+"background-size: "+t+"px "+e+"px;"+o,this.option.fixedSize&&(s+=r+r+"width: "+n+"px;"+o,s+=r+r+"height: "+a+"px;"+o),s+=r+"}\n"},a.prototype._getItemCss=function(t,e,i){var a="."+this.option.className+"-"+n(t.name)+" {"+e;return this.option.fixedSize||(a+=i+"width: "+t.drawWidth+"px;"+e,a+=i+"height: "+t.drawHeight+"px;"+e),a+=i+"background-position: -"+t.x+"px -"+t.y+"px;"+e,a+="}\n"+e},a.prototype._generateCSS=function(t,e,i,n){this.resultCSS={common:null,each:null,validation:null};var a=this.option.width,o=this.option.height,r=this.option.useCr?"\n":"",s=this.option.useCr?"\t":" ",l=this._getNormalCss(this.option.fixedSize,a,o,r,s),h=this.option.prefix+l,p=".cNormal"+l;if(l=null,n){var d=this._getRetinaCss(e.width,e.height,this.option.fixedSize,a,o,r,s);h+="@media (min--moz-device-pixel-ratio: 1.5), (-o-min-device-pixel-ratio: 3/2), (-webkit-min-device-pixel-ratio: 1.5), (min-device-pixel-ratio: 1.5), (min-resolution: 1.5dppx) {\n",h+=s+this.option.prefix+d,h+="}\n",p+=".cRetina"+$.trim(d),d=null}this.resultCSS.common=h,h="";for(var u=void 0,g=0,m=t.length;g<m;g++)u=this._getItemCss(t[g],r,s),h+=this.option.prefix+u,p+=u;return u=null,this.resultCSS.each=h.replace(/-0px/g,"0px"),h=null,p=p.replace("__NORMAL_IMAGE__",this.resultDataURL.normal),n&&(p=p.replace("__RETINA_IMAGE__",this.resultDataURL.retina)),this.resultCSS.validation=p,p=null,this.option.useDataUrl?(this.resultCSS.common=this.resultCSS.common.replace("__NORMAL_IMAGE__",this.resultDataURL.normal),n&&(this.resultCSS.common=this.resultCSS.common.replace("__RETINA_IMAGE__",this.resultDataURL.retina))):(this.resultCSS.common=this.resultCSS.common.replace("__NORMAL_IMAGE__",this.option.urlPrefix+this.getFileName(!1)),n&&(this.resultCSS.common=this.resultCSS.common.replace("__RETINA_IMAGE__",this.option.urlPrefix+this.getFileName(!0)))),this.resultCSS},a.prototype._validateCSS=function(t,e){if(this.setting.onValidation){for(var i=$("<ul/>"),a=void 0,o=0,r=t.length;o<r;o++){var s=t[o].name,l=n(s),h=this.option.className+" "+this.option.className+"-"+l;a=$("<li/>"),a.append("<h3>"+l+"</h3>"),a.append('<div class="cNormal '+h+'"/>'),e&&a.append('<div class="cRetina '+h+'"/>'),a.appendTo(i)}this.setting.onValidation(i),i=null}},a});