define("SpriteGenerator",["RectanglePacking"],function(t){var e=function(t){this.setting={onFileAdded:function(t){},onValidation:function(t){},filesElement:null,dropElement:null},$.extend(!0,this.setting,t),this.option=null,this.items=[],this.resultDataURL={normal:null,retina:null},this.resultCSS={common:null,each:null,validation:null},this._initialize()};function i(t){return t.replace(/^data:image\/(png|jpg);base64,/,"")}function n(t){return t.substr(0,t.lastIndexOf(".")).replace(/[\._]/g,"-")}return e.prototype.addItemByFile=function(t){if(t.type.match("image.*")){var e,i,n=new FileReader;n.onload=(e=this,i=t,function(t){e._addImageItem(t.target.result,i.name,i.size)}),n.readAsDataURL(t),n=null}},e.prototype.getItems=function(){return null!=this.setting.dropElement?this.setting.dropElement.children().map(function(){return $(this).data("sprite-item")}):this.items},e.prototype.generate=function(t){var e=this.getItems();if(null==e||0===e.length)return alert("Please select at least 1 image files."),null;this._initializeOption(),$.extend(!0,this.option,t),this.option.width=parseInt(this.option.width),this.option.height=parseInt(this.option.height),(isNaN(this.option.width)||isNaN(this.option.height))&&(this.option.fixedSize=!1);var i=document.createElement("canvas"),n=this._calcImageLayout(e,!1);if(i.width=n.width,i.height=n.height,this._drawCanvas(e,i),this.resultDataURL={normal:null,retina:null},this.option.retina){var a=document.createElement("canvas");n=this._calcImageLayout(e,this.option.retina),a.width=n.width,a.height=n.height,this._drawCanvas(e,a),this.resultDataURL.normal=a.toDataURL(),this.resultDataURL.retina=i.toDataURL(),this._generateCSS(e,a,i,this.option.retina),a=null}else this.resultDataURL.normal=i.toDataURL(),this._generateCSS(e,i);return i=null,this._validateCSS(e,this.option.retina),e=null,{dataURL:this.resultDataURL,css:this.resultCSS}},e.prototype.export=function(t,e){for(var i={option:t,files:[]},n=this.getItems(),a=0,o=n.length;a<o;a++)i.files.push({name:n[a].name,data:n[a].data,width:n[a].width,height:n[a].height,fileSize:n[a].fileSize});n=null;var r=JSON.stringify(i,null,2);return e&&(r=(r=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(t){var e="number";return/^"/.test(t)?e=/:$/.test(t)?"key":"string":/true|false/.test(t)?e="boolean":/null/.test(t)&&(e="null"),'<span class="'+e+'">'+t+"</span>"})),{data:i,setting:r,normal:this.resultDataURL.normal,retina:this.resultDataURL.retina}},e.prototype.exportToZip=function(t){var e;require(["JSZip"],(e=this,function(n){var a,o,r=new n;r.file(e.getJsonFileName(),e.export(t,!1).setting),null!=e.resultDataURL.normal&&r.file(e.getFileName(!1),i(e.resultDataURL.normal),{base64:!0}),null!=e.resultDataURL.retina&&r.file(e.getFileName(!0),i(e.resultDataURL.retina),{base64:!0}),require(["libs/FileSaver"],(a=r.generate({type:"blob"}),o=e.option.filename+".zip",function(){window.saveAs(a,o)}))}))},e.prototype.getFileName=function(t){return this.option.filename+(t?"@2x":"")+".png"},e.prototype.getJsonFileName=function(){return this.option.filename+".sprite.json"},e.prototype.replaceFiles=function(t){if(this.items=[],null!=this.setting.dropElement&&this.setting.dropElement.empty(),$.isArray(t))for(var e=null,i=0,n=t.length;i<n;i++)e=t[i],this._addImageItem(e.data,e.name,e.fileSize)},e.prototype._initialize=function(){var t;if(null!=this.setting.filesElement&&this.setting.filesElement.on("change",(t=this,function(e){for(var i=e.target.files,n=0,a=i.length;n<a;n++)t.addItemByFile(i[n])})),null!=this.setting.dropElement&&window.File&&window.FileList&&window.FileReader){var e=this.setting.dropElement;e.on("dragover dragleave",function(t){t.stopPropagation(),t.preventDefault(),this.className="dragover"==t.type?"hover":""}),e.on("drop",function(t){return function(e){e.stopPropagation(),e.preventDefault(),$(this).trigger("dragleave");for(var i,n=e.originalEvent,a=n.target.files||n.dataTransfer.files,o=0;i=a[o];o++)t.addItemByFile(i)}}(this)),e=null,require(["Sortable"],function(t){return function(e){e.create(t.setting.dropElement.get(0))}}(this))}},e.prototype._initializeOption=function(){this.option={retina:!1,useCr:!1,useDataUrl:!1,fixedSize:!1,width:-1,height:-1,padding:{top:0,right:0,bottom:0,left:0},layout:"ver",className:"sprite",prefix:"",filename:"sprite",urlPrefix:""}},e.prototype._addImageItem=function(t,e,i){var n=this,a=new Image;a.onload=function(){var o,r={name:e,image:a,data:t,width:a.width,height:a.height,fileSize:i,drawWidth:0,drawHeight:0,drawImageWidth:0,drawImageHeight:0,xOffset:0,yOffset:0,x:0,y:0};if(n.items.push(r),null!=n.setting.dropElement){var s="<span>"+r.name+"</span> <i>("+r.width+"x"+r.height;isNaN(r.fileSize)||(s+=", "+function(t,e){var i=e?1e3:1024;if(Math.abs(t)<i)return t+" B";var n=e?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],a=-1;do{t/=i,++a}while(Math.abs(t)>=i&&a<n.length-1);return t.toFixed(1)+" "+n[a]}(r.fileSize,!0)),s+=")</i>";var l=$("<li/>").append("<i>X</i>").append(r.image).append("<span>"+s+"</span>").data("sprite-item",r);l.find("span > span").on("save",(o=l,function(t,e){var i=o.data("sprite-item");i.name=e.newValue,o.data("sprite-item",i)})).editable(),l.find("> i").on("click",function(t){return function(e,i){t.remove()}}(l)),l.appendTo(n.setting.dropElement),l=null,s=null}n.setting.onFileAdded(r),r=null},a.src=t},e.prototype._calcImageLayout=function(e,i){for(var n=i?2:1,a=i?1:2,o=this.option.fixedSize,r=this.option.retina?2:1,s=Math.floor(this.option.width*r/n),l=Math.floor(this.option.height*r/n),h=0,p=0,d=0,u=0,g=0,m=e.length;g<m;g++)if(e[g].drawImageWidth=Math.floor(e[g].width/n),e[g].drawImageHeight=Math.floor(e[g].height/n),o?(e[g].drawWidth=s,e[g].drawHeight=l):(e[g].drawWidth=e[g].drawImageWidth,e[g].drawHeight=e[g].drawImageHeight),e[g].xOffset=this.option.padding.left*a+Math.ceil((e[g].drawWidth-e[g].drawImageWidth)/2),e[g].yOffset=this.option.padding.top*a+Math.ceil((e[g].drawHeight-e[g].drawImageHeight)/2),e[g].drawWidth+=(this.option.padding.left+this.option.padding.right)*a,e[g].drawHeight+=(this.option.padding.top+this.option.padding.bottom)*a,"compat"!=this.option.layout){switch(e[g].x=h,e[g].y=p,this.option.layout){case"ver":p+=e[g].drawHeight;break;case"hor":h+=e[g].drawWidth}d=Math.max(d,e[g].x+e[g].drawWidth),u=Math.max(u,e[g].y+e[g].drawHeight)}if("compat"==this.option.layout){var f=new t;f.pack(e),d=f.canvasWidth,u=f.canvasHeight}return{width:d,height:u}},e.prototype._drawCanvas=function(t,e){for(var i,n,a=e.getContext("2d"),o=0,r=t.length;o<r;o++)i=t[o].x+t[o].xOffset,n=t[o].y+t[o].yOffset,a.drawImage(t[o].image,i,n,t[o].drawImageWidth,t[o].drawImageHeight);a=null},e.prototype._getNormalCss=function(t,e,i,n,a){var o="."+this.option.className+" {"+n;return o+=a+"background-image: url('__NORMAL_IMAGE__');"+n,this.option.fixedSize&&(o+=a+"width: "+e+"px;"+n,o+=a+"height: "+i+"px;"+n),o+="}\n\n"},e.prototype._getRetinaCss=function(t,e,i,n,a,o,r){var s="."+this.option.className+" {"+o;return s+=r+r+"background-image: url('__RETINA_IMAGE__');"+o,s+=r+r+"background-size: "+t+"px "+e+"px;"+o,this.option.fixedSize&&(s+=r+r+"width: "+n+"px;"+o,s+=r+r+"height: "+a+"px;"+o),s+=r+"}\n"},e.prototype._getItemCss=function(t,e,i){var a="."+this.option.className+"-"+n(t.name)+" {"+e;return this.option.fixedSize||(a+=i+"width: "+t.drawWidth+"px;"+e,a+=i+"height: "+t.drawHeight+"px;"+e),a+=i+"background-position: -"+t.x+"px -"+t.y+"px;"+e,a+="}\n"+e},e.prototype._generateCSS=function(t,e,i,n){this.resultCSS={common:null,each:null,validation:null};var a,o=this.option.width,r=this.option.height,s=this.option.useCr?"\n":"",l=this.option.useCr?"\t":" ",h=this._getNormalCss(this.option.fixedSize,o,r,s,l),p=this.option.prefix+h,d=".cNormal"+h;if(h=null,n){var u=this._getRetinaCss(e.width,e.height,this.option.fixedSize,o,r,s,l);p+="@media (min--moz-device-pixel-ratio: 1.5), (-o-min-device-pixel-ratio: 3/2), (-webkit-min-device-pixel-ratio: 1.5), (min-device-pixel-ratio: 1.5), (min-resolution: 1.5dppx) {\n",p+=l+this.option.prefix+u,p+="}\n",d+=".cRetina"+$.trim(u),u=null}this.resultCSS.common=p,p="";for(var g=0,m=t.length;g<m;g++)a=this._getItemCss(t[g],s,l),p+=this.option.prefix+a,d+=a;return a=null,this.resultCSS.each=p.replace(/-0px/g,"0px"),p=null,d=d.replace("__NORMAL_IMAGE__",this.resultDataURL.normal),n&&(d=d.replace("__RETINA_IMAGE__",this.resultDataURL.retina)),this.resultCSS.validation=d,d=null,this.option.useDataUrl?(this.resultCSS.common=this.resultCSS.common.replace("__NORMAL_IMAGE__",this.resultDataURL.normal),n&&(this.resultCSS.common=this.resultCSS.common.replace("__RETINA_IMAGE__",this.resultDataURL.retina))):(this.resultCSS.common=this.resultCSS.common.replace("__NORMAL_IMAGE__",this.option.urlPrefix+this.getFileName(!1)),n&&(this.resultCSS.common=this.resultCSS.common.replace("__RETINA_IMAGE__",this.option.urlPrefix+this.getFileName(!0)))),this.resultCSS},e.prototype._validateCSS=function(t,e){if(this.setting.onValidation){for(var i,a=$("<ul/>"),o=0,r=t.length;o<r;o++){var s=n(t[o].name),l=this.option.className+" "+this.option.className+"-"+s;(i=$("<li/>")).append("<h3>"+s+"</h3>"),i.append('<div class="cNormal '+l+'"/>'),e&&i.append('<div class="cRetina '+l+'"/>'),i.appendTo(a)}this.setting.onValidation(a),a=null}},e});
